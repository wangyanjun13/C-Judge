#version: '3.8'

services:
  # 数据库服务
  db:
    image: postgres:14-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=cjudge
      - POSTGRES_DB=cjudge
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    ports:
      - "5432:5432"
    command: >
      postgres
      -c max_connections=100
      -c shared_buffers=128MB
      -c effective_cache_size=512MB
      -c maintenance_work_mem=32MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=8MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=100
      -c work_mem=2MB
      -c min_wal_size=512MB
      -c max_wal_size=2GB

  # Redis缓存
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: >
      redis-server
      --appendonly yes
      --save 300 1
      --loglevel warning
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 60
      --timeout 0
      --tcp-backlog 256

  # 后端API服务
  backend:
    image: python:3.9
    working_dir: /app
    volumes:
      - ../backend:/app
      - ./data:/app/data
      - ..:/app_root  # 挂载整个项目目录，题库可以通过 /app_root/题库 访问
    ports:
      - "8000:8000"
    dns:
      - 223.5.5.5  # 阿里云DNS
      - 223.6.6.6  # 阿里云DNS备用
    environment:
      - HTTP_PROXY=
      - HTTPS_PROXY=
      - DATABASE_URL=postgresql://cjudge:password@db:5432/cjudge
      - REDIS_URL=redis://redis:6379/0
      - JUDGE_SERVER_URL=http://oj-judge:8080
      - JUDGE_SERVER_TOKEN=12345678
      - PYTHONPATH=/app
      - TZ=Asia/Shanghai
    depends_on:
      - db
      - redis
    command: >
      sh -c "
        mkdir -p /app/data &&
        pip install -r requirements.txt &&
        uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2 --loop uvloop --http httptools
      "

  # 前端服务
  frontend:
    image: node:18-alpine
    working_dir: /app
    volumes:
      - ../frontend:/app
    ports:
      - "3000:3000"
    dns:
      - 223.5.5.5  # 阿里云DNS
      - 223.6.6.6  # 阿里云DNS备用
    environment:
      - HTTP_PROXY=
      - HTTPS_PROXY=
    depends_on:
      - backend
    command: sh -c "npm config set registry https://registry.npmmirror.com && npm install && npm run dev -- --host"

  # 评测服务
  oj-judge:
    image: registry.cn-hongkong.aliyuncs.com/oj-image/judge:1.6.1
    restart: always
    read_only: true
    cap_drop:
      - SETPCAP
      - MKNOD
      - NET_BIND_SERVICE
      - SYS_CHROOT
      - SETFCAP
      - FSETID
    tmpfs:
      - /tmp
    volumes:
      - ./data/test_case:/test_case:ro
      - ./data/judge/log:/log
      - ./data/judge/run:/judger
      - ..:/root_project:ro  # 挂载整个项目目录，题库可以通过 /root_project/题库 访问
    environment:
      - SERVICE_URL=http://oj-judge:8080
      - BACKEND_URL=http://backend:8000/api/judge_server_heartbeat/
      - TOKEN=12345678
      - DISABLE_HEARTBEAT=1
      # - judger_debug=1
    ports:
      - "8080:8080"

volumes:
  postgres_data:
  redis_data: